!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.writingPanel=e():t.writingPanel=e()}(self,(()=>(()=>{"use strict";var t={d:(e,i)=>{for(var n in i)t.o(i,n)&&!t.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:i[n]})},o:(t,e)=>Object.prototype.hasOwnProperty.call(t,e),r:t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})}},e={};function i(t){return"[object Object]"===Object.prototype.toString.call(t)}function n(t,e=0){return function(t){return"[object Number]"===Object.prototype.toString.call(t)&&!isNaN(t)&&isFinite(t)}(t=Number(t))?t:e}function s(){return/phone|pad|pod|iPhone|iPod|ios|iPad|Android|Mobile|BlackBerry|IEMobile|MQQBrowser|JUC|Fennec|wOSBrowser|BrowserNG|WebOS|Symbian|Windows Phone/i.test(navigator.userAgent)}function o(t){return t.filter((t=>s()?t.startsWith("touch"):t.startsWith("mouse")))}function h(){return"IMG_"+function(t,e="YYYY-MM-dd"){const i={"[Y|y]+":t.getFullYear().toString(),"M+":(t.getMonth()+1).toString(),"d+":t.getDate().toString(),"H+":t.getHours().toString(),"h+":(t.getHours()>=12?t.getHours()-12:t.getHours()).toString(),"m+":t.getMinutes().toString(),"s+":t.getSeconds().toString(),"q+":Math.floor((t.getMonth()+3)/3).toString(),"S+":t.getMilliseconds().toString()};let n;for(const t in i)n=e.match(new RegExp(t,"g")),n&&n.forEach((n=>{e=e.replace(n,i[t].padStart(n.length,"0"))}));return e}(new Date,"YYYYMMddHHmmss")+"_"+(Math.random()*Math.pow(10,8)).toString().slice(0,6)}t.r(e),t.d(e,{WritingPanel:()=>d});const l=["mousedown","touchstart"],r=["mousemove","touchmove"],a=["mouseup","mouseleave","touchend","touchcancel"];class g{constructor(t){this._scale=1;const e=i(t)?t:{};this.height=n(e.height),this.width=n(e.width),this.panelBgColor=e.panelBgColor,this.lineWidth=n(e.lineWidth,1),this.lineCap=e.lineCap||"round",this.lineJoin=e.lineJoin||"round",this.imgType=e.imgType||"png",this.cursorStyle=e.cursorStyle,this._autoResize=!1!==e.autoResize,this._enableDPR=!!e.enableDPR,this.scale=this.enableDPR?window.devicePixelRatio:1}get scale(){return this._scale||1}set scale(t){this._scale=t}get height(){return this._height||0}set height(t){this._height=Math.floor(n(t)*this._scale)}get width(){return this._width||0}set width(t){this._width=Math.floor(n(t)*this._scale)}get panelBgColor(){return this._panelBgColor}set panelBgColor(t){this._panelBgColor=t||"#ffffff"}get lineWidth(){return this._lineWidth||1}set lineWidth(t){this._lineWidth=n(t,1)}get lineColor(){return this._lineColor||"#000000"}set lineColor(t){this._lineColor=t||"#000000"}get lineCap(){return this._lineCap||"round"}set lineCap(t){this._lineCap=["butt","round","square"].includes(t)?t:"round"}get lineJoin(){return this._lineJoin||"round"}set lineJoin(t){this._lineJoin=t||"round"}get imgType(){return this._imgType||"png"}set imgType(t){if(t&&!["png","jpg","jpeg"].includes(t.toLowerCase()))throw Error("图片类型必须是png/jpg/jpeg中的一种");this._imgType=t||"png",this.imageMimeType="png"===this._imgType?"image/png":"image/jpeg"}get imageMimeType(){return this._imageMimeType||"image/png"}set imageMimeType(t){this._imageMimeType=t}get cursorStyle(){return this._cursorStyle||"crosshair"}set cursorStyle(t){this._cursorStyle=t||"crosshair"}get autoResize(){return!!this._autoResize}get enableDPR(){return!!this._enableDPR}}class c{constructor(){this.key="",this.pointList=[]}setLine(t){if(!i(t))throw Error("Line constructor() 传入的参数必须为对象");this.index=t.index,this.key="line_"+t.index,this.pointList=t.pointList||[],this.usable=!0,this.panelBgColor=t.panelBgColor,this.lineColor=t.lineColor,this.lineCap=t.lineCap||"round",this.lineJoin=t.lineJoin||"round",this.lineWidth=t.lineWidth}get key(){return this._key||""}set key(t){this._key=t}get index(){return this._index}set index(t){this._index=t}get usable(){return this._usable||!1}set usable(t){this._usable=t}get panelBgColor(){return this._panelBgColor}set panelBgColor(t){this._panelBgColor=t}get lineColor(){return this._lineColor}set lineColor(t){this._lineColor=t}get lineCap(){return this._lineCap||"round"}set lineCap(t){this._lineCap=t}get lineJoin(){return this._lineJoin||"round"}set lineJoin(t){this._lineJoin=t}get lineWidth(){return this._lineWidth}set lineWidth(t){this._lineWidth=t}get pointList(){return this._pointList||[]}set pointList(t){this._pointList=t}addPoint(t){this.pointList.push(t)}disable(){this.usable=!1}enable(){this.usable=!0}getLastPoint(){return this.pointList&&this.pointList.length?this.pointList[this.pointList.length-1]:void 0}empty(){this.key="",this.index=0,this.pointList=[],this.usable=!1,this.lineColor=null,this.lineCap="round",this.lineWidth=1,this.lineJoin="round"}}class _{constructor(){this.lineList=[]}setLineRecord(t){this.lineList=t||[]}set lineList(t){this._lineList=t}get lineList(){return this._lineList||[]}hasLine(t){return-1!==this.lineList.findIndex((e=>e.key===("string"==typeof t?t:t.key)))}disableLine(t){this.hasLine(t)&&(this.lineList.find((e=>e.key===("string"==typeof t?t:t.key))).usable=!1)}addLine(t){!this.hasLine(t)&&t.key&&this.lineList.push(t)}findLastUsableLine(){const t=this.lineList.filter((t=>t.usable));return t.length?t[t.length-1]:void 0}getUsableLines(){return this.lineList.filter((t=>t.usable))}findFirstDisabledLine(){return this.lineList.find((t=>!t.usable))}isEmpty(){return!this.lineList.length}empty(){this.lineList=[]}}class d{constructor(t,e){if(this._Down=1,this._Writing=2,this._Up=3,this._writingFlag=!1,this._lineIndex=0,this._initialized=!1,this._resetCanvas=()=>{this._initialized&&(!this._panelConfig.enableDPR||this._panelConfig.enableDPR&&this._panelConfig.scale===window.devicePixelRatio)||(this._panelConfig.enableDPR&&(this._panelConfig.scale=window.devicePixelRatio),this._canvas.width=this._panelConfig.width,this._canvas.height=this._panelConfig.height,this._context.scale(this._panelConfig.scale,this._panelConfig.scale),this.setPanelBgColor(),this.setPanelCursorStyle(),this._initialized&&console.log("检测到窗口大小改变，面板已重置."),this._initialized=!0)},this._windowOnResize=()=>{this._panelConfig.autoResize&&this._resetCanvas()},this._readyWriteFun=t=>{o(r).forEach((t=>{this._canvas.addEventListener(t,this._writingFun)})),this._writingFlag=!0,this._line=new c,this._line.setLine({index:this._lineIndex++,panelBgColor:this._panelConfig.panelBgColor,lineColor:this._panelConfig.lineColor,pointList:[]}),this._strokeWrite(t,this._Down)},this._writingFun=t=>{console.log("writing..."),this._strokeWrite(t,this._Writing)},this._stopWriting=t=>{this._canvas.removeEventListener("mousemove",this._writingFun),this._canvas.removeEventListener("touchmove",this._writingFun),this._strokeWrite(t,this._Up)},this.setPanelHeight=t=>(this._canvas.style.height=(t||0)+"px",this._canvas.style.width=this.getPanelWidth(),this),this.getPanelHeight=()=>window.getComputedStyle(this._canvas).getPropertyValue("height"),this.setPanelWidth=t=>(this._canvas.style.width=(t||0)+"px",this._canvas.style.height=this.getPanelHeight(),this),this.getPanelWidth=()=>window.getComputedStyle(this._canvas).getPropertyValue("width"),this.restorePanelWH=(t=!0,e=!0)=>{t&&(this._canvas.style.width=""),e&&(this._canvas.style.height="")},this.setLineWidth=t=>(this._panelConfig.lineWidth=t,this),this.setLineCap=t=>(this._panelConfig.lineCap=t,this),this.setLineColor=t=>(this._panelConfig.lineColor=t,this),this.clearPanel=(t=!0,e=!0)=>{t&&(this._line.empty(),this._lineRecord.empty(),this._lineIndex=0),this._context.clearRect(0,0,this._canvas.width,this._canvas.height),e&&this.setPanelBgColor()},this.getBase64=()=>this._canvas.toDataURL(this._panelConfig.imageMimeType,1),this.getImgBlobOrFile=(t,e)=>new Promise(((i,n)=>{try{const n=this.getBase64().split(","),s=n[0].match(/:(.*?);/)[1],o=atob(n[1]);let l=o.length;const r=new Uint8Array(l);for(;l--;)r[l]=o.charCodeAt(l);let a;"file"===t?(e=e||h(),a=new File([r],e,{type:s})):a=new Blob([r],{type:s}),i(a)}catch(t){console.error(t),n("getImgBlobOrFile()执行异常 ==> 获取Blob|File对象失败")}})),this.saveImgFile=t=>new Promise(((e,i)=>{try{const i=document.createElement("a");i.href=this.getBase64().replace(this._panelConfig.imageMimeType,"image/octet-stream"),i.download=(t||h())+`.${this._panelConfig.imgType}`,i.click(),i.remove(),e(!0)}catch(t){i(t)}})),this.downloadImgFile=t=>new Promise(((e,i)=>{try{this.getImgBlobOrFile().then((i=>{const n=window.URL.createObjectURL(i),s=document.createElement("a");s.download=(t||h())+`.${this._panelConfig.imgType}`,s.href=n,s.click(),s.remove(),window.URL.revokeObjectURL(n),e(!0)})).catch((t=>{throw t}))}catch(t){i(t)}})),this.revoke=()=>{const t=this._lineRecord.findLastUsableLine();t?(t.disable(),this._lineRewrite(!0,!0)):console.warn("revoke() ==>当前暂无可撤销的操作！")},this._lineRewrite=(t=!0,e=!0)=>{t&&this._context.clearRect(0,0,this._canvas.width,this._canvas.height);const i=this._lineRecord.getUsableLines();if(i.length<1)console.warn("lineRewrite() ==> 暂无可重绘的线条");else{e&&this.setPanelBgColor(i[i.length-1].panelBgColor);for(let t=0;t<i.length;t++){const e=i[t];this._context.beginPath(),e.pointList.forEach(((t,i)=>{0===i&&this._context.moveTo(t.x,t.y),this._setLineStyleOnWriting(e),this._context.lineTo(t.x,t.y),this._context.stroke()})),this._context.beginPath()}}},this._setLineStyleOnWriting=(t,e=!1)=>{this._context.lineWidth=t.lineWidth,this._context.lineCap=t.lineCap,this._context.lineJoin=t.lineJoin,this._context.strokeStyle=t.lineColor,this._context.shadowBlur=1,this._context.shadowColor=t.lineColor,e&&(this._line.lineWidth=t.lineWidth,this._line.lineCap=t.lineCap,this._line.lineJoin=t.lineJoin,this._line.lineColor=t.lineColor)},this.recover=()=>{const t=this._lineRecord.findFirstDisabledLine();t?(t.enable(),this._lineRewrite(!0,!0)):console.warn("recover() ==>当前暂无可恢复的操作！")},this.setPanelCursorStyle=(t=null)=>{this._panelConfig.cursorStyle=t,this._canvas.style.cursor=this._panelConfig.cursorStyle},this._removeAllEvtListeners=(t=!1)=>{[...l,...r,...a].forEach((t=>{this._canvas.removeEventListener(t,this._readyWriteFun),this._canvas.removeEventListener(t,this._writingFun),this._canvas.removeEventListener(t,this._stopWriting)})),t&&window.removeEventListener("resize",this._windowOnResize)},this.isEmpty=()=>0===this._lineRecord.getUsableLines().length,this.destroy=()=>{this.clearPanel();const t=this._canvas.parentElement;if(t){const e=document.createElement("canvas");e.setAttribute("width",String(this._panelConfig.width)),e.setAttribute("height",String(this._panelConfig.height)),t.replaceChild(e,this._canvas),this._canvas=e}this._removeAllEvtListeners(!0),console.log("destroy() ==> 写字板[canvas]已销毁.")},!t.getContext)throw Error("您的浏览器不支持 HTML5 canvas 标签");this._canvas=t,this._context=this._canvas.getContext("2d"),this._panelConfig=new g(e),this._isMobilePlatform=s(),this._initPanel()}_initPanel(){this._line=new c,this._lineRecord=new _,this._panelConfig.autoResize&&window.addEventListener("resize",this._windowOnResize),this._resetCanvas(),this._setEventListeners(),console.log("写字板初始化完毕")}_setEventListeners(){o(l).forEach((t=>{this._canvas.addEventListener(t,this._readyWriteFun)})),o(a).forEach((t=>{this._canvas.addEventListener(t,this._stopWriting)}))}_strokeWrite(t,e){t.preventDefault();let i=t;this._isMobilePlatform&&(i=t.changedTouches[0]);const n=this._canvas.getBoundingClientRect(),s={x:(i.clientX-n.left)*(this._canvas.width/parseFloat(this.getPanelWidth())),y:(i.clientY-n.top)*(this._canvas.height/parseFloat(this.getPanelHeight()))};switch(s.x=s.x/this._panelConfig.scale,s.y=s.y/this._panelConfig.scale,e){case this._Down:console.log("start writing"),this._context.beginPath(),this._context.moveTo(s.x,s.y),this._context.lineTo(s.x,s.y),this._setLineStyleOnWriting(this._panelConfig,!0),this._context.stroke(),this._line.addPoint(s),this._writingFlag=!0;break;case this._Writing:if(this._writingFlag){const t=this._line.getLastPoint();if(t){const e=(s.x+t.x)/2,i=(s.y+t.y)/2;this._context.quadraticCurveTo(e,i,s.x,s.y)}else this._context.lineTo(s.x,s.y);this._context.stroke(),this._line.addPoint(s)}break;case this._Up:default:this._writingFlag&&(this._context.lineTo(s.x,s.y),this._context.stroke(),this._line.addPoint(s),this._writingFlag=!1,this._context.stroke(),console.log("end writing")),this._lineRecord.addLine(this._line),this._context.beginPath()}}setPanelBgColor(t=null,e=!1){return t&&(this._panelConfig.panelBgColor=t),this._context.fillStyle=this._panelConfig.panelBgColor,this._context.fillRect(0,0,this._canvas.width,this._canvas.height),e&&this._lineRewrite(!1,!1),this}getPanelBgColor(){return this._panelConfig.panelBgColor}}return e})()));